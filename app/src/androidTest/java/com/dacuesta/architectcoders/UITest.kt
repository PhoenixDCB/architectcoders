package com.dacuesta.architectcoders

import androidx.recyclerview.widget.RecyclerView
import androidx.test.espresso.Espresso.onView
import androidx.test.espresso.IdlingRegistry
import androidx.test.espresso.action.ViewActions.click
import androidx.test.espresso.assertion.ViewAssertions.matches
import androidx.test.espresso.contrib.RecyclerViewActions
import androidx.test.espresso.matcher.ViewMatchers.*
import androidx.test.rule.ActivityTestRule
import androidx.test.rule.GrantPermissionRule
import com.dacuesta.architectcoders.movies.MoviesActivity
import com.jakewharton.espresso.OkHttp3IdlingResource
import okhttp3.mockwebserver.MockResponse
import org.junit.Before
import org.junit.Rule
import org.junit.Test
import org.koin.test.KoinTest
import org.koin.test.get

class UITest : KoinTest {

    @get:Rule
    val mockWebServerRule =
        MockWebServerRule()

    @get:Rule
    val activityTestRule =
        ActivityTestRule(MoviesActivity::class.java, false, false)

    @get:Rule
    val grantPermissionRule: GrantPermissionRule =
        GrantPermissionRule.grant("android.permission.ACCESS_COARSE_LOCATION")

    @Before
    fun setUp() {
        mockWebServerRule.server.enqueue(
            MockResponse()
                .addHeader("Content-Type", "application/json; charset=utf-8")
                .addHeader("Cache-Control", "no-cache")
                .setResponseCode(200)
                .setBody("{\"page\":1,\"total_results\":10000,\"total_pages\":500,\"results\":[{\"popularity\":1919.377,\"vote_count\":1756,\"video\":false,\"poster_path\":\"\\/aKx1ARwG55zZ0GpRvU2WrGrCG9o.jpg\",\"id\":337401,\"adult\":false,\"backdrop_path\":\"\\/zzWGRw277MNoCs3zhyG3YmYQsXv.jpg\",\"original_language\":\"en\",\"original_title\":\"Mulan\",\"genre_ids\":[28,12,18,14,10752],\"title\":\"Mulan\",\"vote_average\":7.5,\"overview\":\"When the Emperor of China issues a decree that one man per family must serve in the Imperial Chinese Army to defend the country from Huns, Hua Mulan, the eldest daughter of an honored warrior, steps in to take the place of her ailing father. She is spirited, determined and quick on her feet. Disguised as a man by the name of Hua Jun, she is tested every step of the way and must harness her innermost strength and embrace her true potential.\",\"release_date\":\"2020-09-04\"},{\"popularity\":859.153,\"vote_count\":154,\"video\":false,\"poster_path\":\"\\/sMO1v5TUf8GOJHbJieDXsgWT2Ud.jpg\",\"id\":438396,\"adult\":false,\"backdrop_path\":\"\\/qGZe9qTuydxyJYQ60XDtEckzLR8.jpg\",\"original_language\":\"es\",\"original_title\":\"Orígenes secretos\",\"genre_ids\":[18,53],\"title\":\"Unknown Origins\",\"vote_average\":6.2,\"overview\":\"In Madrid, Spain, a mysterious serial killer ruthlessly murders his victims by recreating the first appearance of several comic book superheroes. Cosme, a veteran police inspector who is about to retire, works on the case along with the tormented inspector David Valentín and his own son Jorge Elías, a nerdy young man who owns a comic book store.\",\"release_date\":\"2020-08-28\"},{\"popularity\":855.316,\"vote_count\":462,\"video\":false,\"poster_path\":\"\\/sy6DvAu72kjoseZEjocnm2ZZ09i.jpg\",\"id\":581392,\"adult\":false,\"backdrop_path\":\"\\/gEjNlhZhyHeto6Fy5wWy5Uk3A9D.jpg\",\"original_language\":\"ko\",\"original_title\":\"반도\",\"genre_ids\":[28,27,53],\"title\":\"Peninsula\",\"vote_average\":7.1,\"overview\":\"A soldier and his team battle hordes of post-apocalyptic zombies in the wastelands of the Korean Peninsula.\",\"release_date\":\"2020-11-06\"},{\"popularity\":674.842,\"vote_count\":1238,\"video\":false,\"poster_path\":\"\\/TnOeov4w0sTtV2gqICqIxVi74V.jpg\",\"id\":605116,\"adult\":false,\"backdrop_path\":\"\\/qVygtf2vU15L2yKS4Ke44U4oMdD.jpg\",\"original_language\":\"en\",\"original_title\":\"Project Power\",\"genre_ids\":[28,80,878],\"title\":\"Project Power\",\"vote_average\":6.7,\"overview\":\"An ex-soldier, a teen and a cop collide in New Orleans as they hunt for the source behind a dangerous new pill that grants users temporary superpowers.\",\"release_date\":\"2020-08-14\"},{\"popularity\":575.679,\"vote_count\":306,\"video\":false,\"poster_path\":\"\\/kiX7UYfOpYrMFSAGbI6j1pFkLzQ.jpg\",\"id\":613504,\"adult\":false,\"backdrop_path\":\"\\/r5srC0cqU36n38azFnCyReEksiR.jpg\",\"original_language\":\"en\",\"original_title\":\"After We Collided\",\"genre_ids\":[18,10749],\"title\":\"After We Collided\",\"vote_average\":6.8,\"overview\":\"Tessa finds herself struggling with her complicated relationship with Hardin; she faces a dilemma that could change their lives forever.\",\"release_date\":\"2020-09-04\"},{\"popularity\":526.499,\"vote_count\":72,\"video\":false,\"poster_path\":\"\\/afOa3CpPffC3uQCH2fhMaO3AYpB.jpg\",\"id\":594328,\"adult\":false,\"backdrop_path\":\"\\/lkeBhXGJFRlhI7cBWn8LQQAdZqK.jpg\",\"original_language\":\"en\",\"original_title\":\"Phineas and Ferb  The Movie Candace Against the Universe\",\"genre_ids\":[16,35,10402,878,10751,10770],\"title\":\"Phineas and Ferb  The Movie Candace Against the Universe\",\"vote_average\":7,\"overview\":\"Phineas and Ferb travel across the galaxy to rescue their older sister Candace, who has been abducted by aliens and taken to a utopia in a far-off planet, free of her pesky little brothers.\",\"release_date\":\"2020-08-28\"},{\"popularity\":398.92,\"vote_count\":640,\"video\":false,\"poster_path\":\"\\/jHo2M1OiH9Re33jYtUQdfzPeUkx.jpg\",\"id\":385103,\"adult\":false,\"backdrop_path\":\"\\/fKtYXUhX5fxMxzQfyUcQW9Shik6.jpg\",\"original_language\":\"en\",\"original_title\":\"Scoob!\",\"genre_ids\":[12,16,35,10751],\"title\":\"Scoob!\",\"vote_average\":7.3,\"overview\":\"In Scooby-Doo’s greatest adventure yet, see the never-before told story of how lifelong friends Scooby and Shaggy first met and how they joined forces with young detectives Fred, Velma, and Daphne to form the famous Mystery Inc. Now, with hundreds of cases solved, Scooby and the gang face their biggest, toughest mystery ever: an evil plot to unleash the ghost dog Cerberus upon the world. As they race to stop this global “dogpocalypse,” the gang discovers that Scooby has a secret legacy and an epic destiny greater than anyone ever imagined.\",\"release_date\":\"2020-07-15\"},{\"popularity\":391.371,\"vote_count\":5200,\"video\":false,\"poster_path\":\"\\/y95lQLnuNKdPAzw9F9Ab8kJ80c3.jpg\",\"id\":38700,\"adult\":false,\"backdrop_path\":\"\\/upUy2QhMZEmtypPW3PdieKLAHxh.jpg\",\"original_language\":\"en\",\"original_title\":\"Bad Boys for Life\",\"genre_ids\":[28,80,53],\"title\":\"Bad Boys for Life\",\"vote_average\":7.3,\"overview\":\"Marcus and Mike are forced to confront new threats, career changes, and midlife crises as they join the newly created elite team AMMO of the Miami police department to take down the ruthless Armando Armas, the vicious leader of a Miami drug cartel.\",\"release_date\":\"2020-01-17\"},{\"popularity\":367.681,\"vote_count\":2021,\"video\":false,\"poster_path\":\"\\/cjr4NWURcVN3gW5FlHeabgBHLrY.jpg\",\"id\":547016,\"adult\":false,\"backdrop_path\":\"\\/m0ObOaJBerZ3Unc74l471ar8Iiy.jpg\",\"original_language\":\"en\",\"original_title\":\"The Old Guard\",\"genre_ids\":[28,14],\"title\":\"The Old Guard\",\"vote_average\":7.3,\"overview\":\"Four undying warriors who've secretly protected humanity for centuries become targeted for their mysterious powers just as they discover a new immortal.\",\"release_date\":\"2020-07-10\"},{\"popularity\":364.364,\"vote_count\":13,\"video\":false,\"poster_path\":\"\\/zXAwq18CJYmzhLZNbLpBf3dG3A5.jpg\",\"id\":546724,\"adult\":false,\"backdrop_path\":\"\\/vUI5FHBCjBHrRCf6ZEVf8uA4VrE.jpg\",\"original_language\":\"en\",\"original_title\":\"We Summon the Darkness\",\"genre_ids\":[27,53],\"title\":\"We Summon the Darkness\",\"vote_average\":6.3,\"overview\":\"Three best friends attending a heavy-metal show cross paths with sadistic killers after they travel to a secluded country home for an after party.\",\"release_date\":\"2019-11-11\"},{\"popularity\":354.886,\"vote_count\":5676,\"video\":false,\"poster_path\":\"\\/aQvJ5WPzZgYVDrxLX4R6cLJCEaQ.jpg\",\"id\":454626,\"adult\":false,\"backdrop_path\":\"\\/stmYfCUGd8Iy6kAMBr6AmWqx8Bq.jpg\",\"original_language\":\"en\",\"original_title\":\"Sonic the Hedgehog\",\"genre_ids\":[28,35,878,10751],\"title\":\"Sonic the Hedgehog\",\"vote_average\":7.5,\"overview\":\"Based on the global blockbuster videogame franchise from Sega, Sonic the Hedgehog tells the story of the world’s speediest hedgehog as he embraces his new home on Earth. In this live-action adventure comedy, Sonic and his new best friend team up to defend the planet from the evil genius Dr. Robotnik and his plans for world domination.\",\"release_date\":\"2020-02-14\"},{\"popularity\":347.417,\"vote_count\":5802,\"video\":false,\"poster_path\":\"\\/h4VB6m0RwcicVEZvzftYZyKXs6K.jpg\",\"id\":495764,\"adult\":false,\"backdrop_path\":\"\\/9xNOiv6DZZjH7ABoUUDP0ZynouU.jpg\",\"original_language\":\"en\",\"original_title\":\"Birds of Prey (and the Fantabulous Emancipation of One Harley Quinn)\",\"genre_ids\":[28,35,80],\"title\":\"Birds of Prey (and the Fantabulous Emancipation of One Harley Quinn)\",\"vote_average\":7.2,\"overview\":\"Harley Quinn joins forces with a singer, an assassin and a police detective to help a young girl who had a hit placed on her after she stole a rare diamond from a crime lord.\",\"release_date\":\"2020-02-07\"},{\"popularity\":338.101,\"vote_count\":159,\"video\":false,\"poster_path\":\"\\/aVbqhqYtlxwEGihTEhewZAgDOCX.jpg\",\"id\":489326,\"adult\":false,\"backdrop_path\":\"\\/dFB6Tiy3z2xRLbnEUB5ocApT5xG.jpg\",\"original_language\":\"en\",\"original_title\":\"Mortal\",\"genre_ids\":[28,14,53],\"title\":\"Mortal\",\"vote_average\":6.6,\"overview\":\"A young boy must discover the origins of his extraordinary powers before he is captured by authorities hell-bent on condemning him for an accidental murder.\",\"release_date\":\"2020-07-31\"},{\"popularity\":337.371,\"vote_count\":14817,\"video\":false,\"poster_path\":\"\\/udDclJoHjfjb8Ekgsd4FDteOkCU.jpg\",\"id\":475557,\"adult\":false,\"backdrop_path\":\"\\/n6bUvigpRFqSwmPp1m2YADdbRBc.jpg\",\"original_language\":\"en\",\"original_title\":\"Joker\",\"genre_ids\":[80,18,53],\"title\":\"Joker\",\"vote_average\":8.2,\"overview\":\"During the 1980s, a failed stand-up comedian is driven insane and turns to a life of crime and chaos in Gotham City while becoming an infamous psychopathic crime figure.\",\"release_date\":\"2019-10-04\"},{\"popularity\":337.358,\"vote_count\":824,\"video\":false,\"poster_path\":\"\\/tI8ocADh22GtQFV28vGHaBZVb0U.jpg\",\"id\":475430,\"adult\":false,\"backdrop_path\":\"\\/o0F8xAt8YuEm5mEZviX5pEFC12y.jpg\",\"original_language\":\"en\",\"original_title\":\"Artemis Fowl\",\"genre_ids\":[28,12,14,878,10751],\"title\":\"Artemis Fowl\",\"vote_average\":5.8,\"overview\":\"Artemis Fowl is a 12-year-old genius and descendant of a long line of criminal masterminds. He soon finds himself in an epic battle against a race of powerful underground fairies who may be behind his father's disappearance.\",\"release_date\":\"2020-06-12\"},{\"popularity\":330.253,\"vote_count\":1641,\"video\":false,\"poster_path\":\"\\/k68nPLbIST6NP96JmTxmZijEvCA.jpg\",\"id\":577922,\"adult\":false,\"backdrop_path\":\"\\/wzJRB4MKi3yK138bJyuL9nx47y6.jpg\",\"original_language\":\"en\",\"original_title\":\"Tenet\",\"genre_ids\":[28,878,53],\"title\":\"Tenet\",\"vote_average\":7.5,\"overview\":\"Armed with only one word - Tenet - and fighting for the survival of the entire world, the Protagonist journeys through a twilight world of international espionage on a mission that will unfold in something beyond real time.\",\"release_date\":\"2020-08-26\"},{\"popularity\":308.29,\"vote_count\":380,\"video\":false,\"poster_path\":\"\\/zGVbrulkupqpbwgiNedkJPyQum4.jpg\",\"id\":592350,\"adult\":false,\"backdrop_path\":\"\\/9guoVF7zayiiUq5ulKQpt375VIy.jpg\",\"original_language\":\"ja\",\"original_title\":\"僕のヒーローアカデミア THE MOVIE ヒーローズ：ライジング\",\"genre_ids\":[28,16],\"title\":\"My Hero Academia: Heroes Rising\",\"vote_average\":8.7,\"overview\":\"Class 1-A visits Nabu Island where they finally get to do some real hero work. The place is so peaceful that it's more like a vacation … until they're attacked by a villain with an unfathomable Quirk! His power is eerily familiar, and it looks like Shigaraki had a hand in the plan. But with All Might retired and citizens' lives on the line, there's no time for questions. Deku and his friends are the next generation of heroes, and they're the island's only hope.\",\"release_date\":\"2020-09-11\"},{\"popularity\":280.811,\"vote_count\":1116,\"video\":false,\"poster_path\":\"\\/7W0G3YECgDAfnuiHG91r8WqgIOe.jpg\",\"id\":446893,\"adult\":false,\"backdrop_path\":\"\\/qsxhnirlp7y4Ae9bd11oYJSX59j.jpg\",\"original_language\":\"en\",\"original_title\":\"Trolls World Tour\",\"genre_ids\":[12,16,35,14,10402,10751],\"title\":\"Trolls World Tour\",\"vote_average\":7.6,\"overview\":\"Queen Poppy and Branch make a surprising discovery — there are other Troll worlds beyond their own, and their distinct differences create big clashes between these various tribes. When a mysterious threat puts all of the Trolls across the land in danger, Poppy, Branch, and their band of friends must embark on an epic quest to create harmony among the feuding Trolls to unite them against certain doom.\",\"release_date\":\"2020-10-23\"},{\"popularity\":263.509,\"vote_count\":1154,\"video\":false,\"poster_path\":\"\\/kjMbDciooTbJPofVXgAoFjfX8Of.jpg\",\"id\":516486,\"adult\":false,\"backdrop_path\":\"\\/xXBnM6uSTk6qqCf0SRZKXcga9Ba.jpg\",\"original_language\":\"en\",\"original_title\":\"Greyhound\",\"genre_ids\":[28,18,10752],\"title\":\"Greyhound\",\"vote_average\":7.5,\"overview\":\"A first-time captain leads a convoy of allied ships carrying thousands of soldiers across the treacherous waters of the “Black Pit” to the front lines of WW2. With no air cover protection for 5 days, the captain and his convoy must battle the surrounding enemy Nazi U-boats in order to give the allies a chance to win the war.\",\"release_date\":\"2020-07-10\"},{\"popularity\":261.831,\"vote_count\":3107,\"video\":false,\"poster_path\":\"\\/f4aul3FyD3jv3v4bul1IrkWZvzq.jpg\",\"id\":508439,\"adult\":false,\"backdrop_path\":\"\\/xFxk4vnirOtUxpOEWgA1MCRfy6J.jpg\",\"original_language\":\"en\",\"original_title\":\"Onward\",\"genre_ids\":[12,16,35,14,10751],\"title\":\"Onward\",\"vote_average\":7.9,\"overview\":\"In a suburban fantasy world, two teenage elf brothers embark on an extraordinary quest to discover if there is still a little magic left out there.\",\"release_date\":\"2020-03-06\"}]}")
        )

        val resource = OkHttp3IdlingResource.create("OkHttp", get())
        IdlingRegistry.getInstance().register(resource)

        activityTestRule.launchActivity(null)
    }

    @Test
    fun click_a_movie() {
        Thread.sleep(700)

        onView(withId(R.id.movies_rv))
            .perform(RecyclerViewActions.actionOnItemAtPosition<RecyclerView.ViewHolder>(0, click()))

        Thread.sleep(700)

        onView(withId(R.id.toolbar))
            .check(matches(hasDescendant(withText("Mulan"))))
    }

}